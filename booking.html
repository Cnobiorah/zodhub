<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book ‚Äî Z√∂D Hub</title>

  <!-- ‚úÖ Your original CSS (kept exactly the same) -->
  <style>
    :root{
      --bg:#fbfbf8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;
      --accent:#0b3b89;
      --radius:18px;
      --shadow:0 10px 28px rgba(2,6,23,.08);
      --shadow2:0 6px 16px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}

    .nav{
      position:sticky; top:0; z-index:10;
      background:rgba(251,251,248,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .container{max-width:1100px; margin:0 auto; padding:18px}
    .nav-inner{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .mark{width:34px; height:34px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#0ea5e9); box-shadow:var(--shadow2)}
    .nav-links{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .nav-links a{padding:10px 10px; border-radius:12px; color:var(--muted); font-weight:700}
    .nav-links a:hover{background:#fff; color:var(--text); box-shadow:var(--shadow2)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:14px;
      font-weight:800;
      border:1px solid transparent;
      cursor:pointer;
    }
    .btn-primary{background:var(--accent); color:#fff; box-shadow:var(--shadow2)}
    .btn-primary:hover{filter:brightness(.96)}
    .btn-outline{background:transparent; border-color:var(--line); color:var(--text)}
    .btn-outline:hover{background:#fff; box-shadow:var(--shadow2)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .page-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin:10px 0 12px;
    }
    h1{margin:0; font-size:28px}
    .sub{color:var(--muted); font-size:13px}

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      background:#fff; border:1px solid var(--line); border-radius:16px;
      padding:8px; box-shadow:var(--shadow2);
    }
    .tab{
      padding:10px 12px; border-radius:14px; font-weight:900;
      border:1px solid transparent;
      color:var(--muted);
      background:transparent;
      cursor:pointer;
    }
    .tab.active{
      background:rgba(11,59,137,.08);
      border-color:rgba(11,59,137,.25);
      color:var(--text);
    }

    .layout{
      display:grid; grid-template-columns:1.35fr .65fr; gap:18px;
      align-items:start;
      margin-top:14px;
    }
    @media (max-width: 900px){ .layout{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      padding:16px;
    }
    .card h2{margin:0 0 8px; font-size:18px}
    .meta{color:var(--muted); font-size:13px}
    .hr{height:1px; background:var(--line); margin:14px 0}

    .form{display:grid; gap:12px}
    label{font-weight:900; font-size:13px}
    input, select{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font:inherit;
    }
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 700px){ .grid2{grid-template-columns:1fr} }

    .notice{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
    }
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:900;
      border:1px solid var(--line);
      background:#fff;
    }
    .ok{border-color:#bbf7d0; background:#f0fdf4; color:#166534}
    .no{border-color:#fecaca; background:#fef2f2; color:#991b1b}
    .warn{border-color:#fde68a; background:#fffbeb; color:#92400e}

    .pick{
      display:grid; gap:10px;
      border:1px dashed var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .pick .row{display:flex; gap:10px; flex-wrap:wrap}
    .choice{
      flex:1;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .choice:hover{box-shadow:var(--shadow2)}
    .choice[aria-disabled="true"]{opacity:.55; cursor:not-allowed}
    .sticky{
      position:sticky; top:88px;
    }
    .summary-line{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:8px 0;
      font-weight:800;
    }
    .small{font-size:12px; color:var(--muted)}

    /* ===== NAVBAR: consistent CTA (BOOK NOW) ===== */
    /* Only non-button nav links get the hover tile */
    .nav-links a:not(.btn):hover{
      background:#fff;
      color:var(--text);
      box-shadow:var(--shadow2);
      opacity:1;
    }
    /* BOOK NOW stays blue + white always */
    .nav-links a.btn.btn-primary,
    .nav-links a.btn.btn-primary:visited{
      background: var(--accent);
      color:#fff;
      opacity:1;
      filter:none;
    }
    .nav-links a.btn.btn-primary:hover,
    .nav-links a.btn.btn-primary:focus{
      background: var(--accent);
      color:#fff;
      opacity:1;
      filter:none;
      box-shadow: var(--shadow2);
    }
  </style>
</head>

<body>
  <!-- NAV -->
  <div class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html"><span class="mark"></span><span>Z√∂D Hub</span></a>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="faq.html">FAQs</a>
        <a href="location.html#contact">Contact</a>
        <a class="btn btn-primary" href="booking.html">BOOK NOW</a>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- HEADER -->
    <div class="page-head">
      <div>
        <h1>Book a Workspace</h1>
        <div class="sub">General = seat pool. Private = specific room (P01/P02).</div>
      </div>

      <div class="tabs" role="tablist" aria-label="Booking type">
        <button class="tab active" id="tab-general" role="tab" aria-selected="true">General Space</button>
        <button class="tab" id="tab-private" role="tab" aria-selected="false">Private Space</button>
      </div>
    </div>

    <!-- LAYOUT -->
    <section class="layout">
      <!-- LEFT: GENERAL -->
      <div class="card" id="panel-general">
        <h2>General Space (Seat Pool)</h2>
        <p class="meta">Choose date + package + number of seats.</p>

        <div class="hr"></div>

        <form class="form" onsubmit="return false;">
          <div class="grid2">
            <div>
              <label for="genStart">Start date</label>
              <input id="genStart" type="date" />
            </div>

            <div>
              <label for="genPackage">Package</label>
              <select id="genPackage">
                <option value="">Select package</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label for="genSeats">Seats</label>
              <input id="genSeats" type="number" min="1" value="1" />
            </div>

            <div>
              <label for="genSeatInfo">Seat assignment</label>
              <input id="genSeatInfo" type="text" value="Seat assigned at front desk" disabled />
            </div>
          </div>

          <div class="notice" id="genAvailability">
            <span class="badge warn">Select a date + package</span>
            <span class="meta"> Availability will appear here.</span>
          </div>

          <div class="grid2">
            <div>
              <label for="fullName">Full name</label>
              <input id="fullName" type="text" placeholder="Your name" />
            </div>
            <div>
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="you@email.com" />
            </div>
          </div>

          <div>
            <label for="phone">Phone (optional)</label>
            <input id="phone" type="tel" placeholder="+44..." />
          </div>

          <button class="btn btn-primary" id="genContinue" type="button" disabled>
            Continue to Payment
          </button>

          <div class="small">Only <b>paid</b> bookings block availability (prevents false ‚Äúbooked‚Äù states).</div>
        </form>
      </div>

      <!-- LEFT: PRIVATE -->
      <div class="card" id="panel-private" style="display:none;">
        <h2>Private Space</h2>
        <p class="meta">Choose room + date + package.</p>

        <div class="hr"></div>

        <form class="form" onsubmit="return false;">
          <div class="grid2">
            <div>
              <label for="privDate">Start date</label>
              <input id="privDate" type="date" />
            </div>
            <div>
              <label for="privPackage">Package</label>
              <select id="privPackage">
                <option value="">Select package</option>
              </select>
            </div>
          </div>

          <div class="pick">
            <b style="font-size:13px">Choose a private room</b>
            <div class="meta">Rooms are exclusive (one booking at a time).</div>

            <div class="row">
              <div class="choice" id="pickP01" role="button" tabindex="0" aria-disabled="true">
                <span>P01</span>
                <span class="badge warn" id="p01Badge">Select date</span>
              </div>
              <div class="choice" id="pickP02" role="button" tabindex="0" aria-disabled="true">
                <span>P02</span>
                <span class="badge warn" id="p02Badge">Select date</span>
              </div>
            </div>

            <div class="meta">Chosen: <b id="privChosen">‚Äî</b></div>
          </div>

          <div class="grid2">
            <div>
              <label for="privName">Full name</label>
              <input id="privName" type="text" placeholder="Your name" />
            </div>
            <div>
              <label for="privEmail">Email</label>
              <input id="privEmail" type="email" placeholder="you@email.com" />
            </div>
          </div>

          <button class="btn btn-primary" id="privContinue" type="button" disabled>
            Continue to Payment
          </button>

          <div class="small">Only <b>paid</b> bookings block availability.</div>
        </form>
      </div>

      <!-- RIGHT: SUMMARY -->
      <aside class="card sticky">
        <h2>Booking Summary</h2>
        <p class="meta" id="summaryType">‚Äî</p>

        <div class="hr"></div>

        <div class="summary-line">
          <span>Space</span>
          <span id="summarySpace">‚Äî</span>
        </div>
        <div class="summary-line">
          <span>Dates</span>
          <span id="summaryDates">‚Äî</span>
        </div>
        <div class="summary-line">
          <span>Package</span>
          <span id="summaryPackage">‚Äî</span>
        </div>

        <div class="hr"></div>

        <div class="summary-line" style="font-size:18px">
          <span>Total</span>
          <span id="summaryTotal">‚Äî</span>
        </div>

        <div class="hr"></div>

        <div class="notice">
          <b style="font-size:13px">Entry</b><br />
          <span class="meta">Show your confirmation at the front desk.</span>
        </div>
      </aside>
    </section>
  </main>

  <!-- Supabase browser client (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    // =========================
    // CONFIG (use your existing keys)
    // =========================
    const SUPABASE_URL = "https://dzazdrpgedrrcnuzgjjc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6YXpkcnBnZWRycmNudXpnampjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjUxOTQsImV4cCI6MjA4MjcwMTE5NH0.8ZRnOiGtyfi5ibmTbKLROnQ4PqBIDvDfeH-mWGUQy_M";
    const FUNCTIONS_BASE = "https://dzazdrpgedrrcnuzgjjc.functions.supabase.co";
    const CALLBACK_URL = `${window.location.origin}/confirmation.html`;

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ‚úÖ Option B tables (the new schema we discussed)
    // - packages
    // - resources (GENERAL, P01, P02)
    // - bookings (status: pending/paid)

    const CURRENCY = "NGN";

    // Tabs
    const tabGeneral = document.getElementById("tab-general");
    const tabPrivate = document.getElementById("tab-private");
    const panelGeneral = document.getElementById("panel-general");
    const panelPrivate = document.getElementById("panel-private");

    function showGeneral(){
      tabGeneral.classList.add("active");
      tabPrivate.classList.remove("active");
      tabGeneral.setAttribute("aria-selected","true");
      tabPrivate.setAttribute("aria-selected","false");
      panelGeneral.style.display = "";
      panelPrivate.style.display = "none";
      syncSummaryFromGeneral();
    }
    function showPrivate(){
      tabPrivate.classList.add("active");
      tabGeneral.classList.remove("active");
      tabPrivate.setAttribute("aria-selected","true");
      tabGeneral.setAttribute("aria-selected","false");
      panelPrivate.style.display = "";
      panelGeneral.style.display = "none";
      syncSummaryFromPrivate();
    }
    tabGeneral.addEventListener("click", showGeneral);
    tabPrivate.addEventListener("click", showPrivate);

    // Summary elements
    const summaryType = document.getElementById("summaryType");
    const summarySpace = document.getElementById("summarySpace");
    const summaryDates = document.getElementById("summaryDates");
    const summaryPackage = document.getElementById("summaryPackage");
    const summaryTotal = document.getElementById("summaryTotal");

    // General elements
    const genStart = document.getElementById("genStart");
    const genPackage = document.getElementById("genPackage");
    const genSeats = document.getElementById("genSeats");
    const genAvailability = document.getElementById("genAvailability");
    const genContinue = document.getElementById("genContinue");

    // Private elements
    const privDate = document.getElementById("privDate");
    const privPackage = document.getElementById("privPackage");
    const pickP01 = document.getElementById("pickP01");
    const pickP02 = document.getElementById("pickP02");
    const p01Badge = document.getElementById("p01Badge");
    const p02Badge = document.getElementById("p02Badge");
    const privChosenEl = document.getElementById("privChosen");
    const privContinue = document.getElementById("privContinue");

    let packages = [];
    let resources = [];
    let generalResource = null;
    let privSelected = null;

    function money(n){
      return new Intl.NumberFormat("en-NG", { style:"currency", currency:CURRENCY }).format(Number(n || 0));
    }

    function todayISO(){
      return new Date().toISOString().slice(0,10);
    }

    function addDaysInclusive(startDateStr, durationDays){
      const d = new Date(startDateStr + "T00:00:00Z");
      d.setUTCDate(d.getUTCDate() + (Number(durationDays) - 1));
      return d.toISOString().slice(0,10);
    }

    function setChoiceEnabled(el, enabled){
      el.setAttribute("aria-disabled", enabled ? "false" : "true");
    }

    function selectedPkg(selectEl){
      const id = selectEl.value;
      return packages.find(p => p.id === id) || null;
    }

    async function loadPackagesAndResources(){
      // packages
      const { data: pkgData, error: pkgErr } = await sb
        .from("packages")
        .select("id, code, name, duration_days, price_ngn, is_active")
        .or("is_active.eq.true,is_active.is.null")
        .order("duration_days", { ascending: true });

      if(pkgErr) throw pkgErr;
      packages = pkgData || [];

      const pkgOptions = ['<option value="">Select package</option>']
        .concat(packages.map(p => `<option value="${p.id}">${p.name}</option>`))
        .join("");

      genPackage.innerHTML = pkgOptions;
      privPackage.innerHTML = pkgOptions;

      // resources
      const { data: resData, error: resErr } = await sb
        .from("resources")
        .select("id, type, code, name, capacity, is_active")
        .eq("is_active", true)
        .order("code", { ascending: true });

      if(resErr) throw resErr;
      resources = resData || [];
      generalResource = resources.find(r => r.code === "GENERAL") || null;

      if(!generalResource){
        console.warn("GENERAL resource not found. Ensure resources has code='GENERAL'.");
      }
    }

    // ---------- Availability checks (paid bookings only)
    async function generalSeatsRemaining(start, end){
      if(!generalResource) return { remaining: 0, capacity: 0, booked: 0 };

      const { data, error } = await sb
        .from("bookings")
        .select("seats_qty")
        .eq("resource_id", generalResource.id)
        .eq("status", "paid")
        .lte("start_date", end)
        .gte("end_date", start);

      if(error) throw error;

      const booked = (data || []).reduce((s, b) => s + Number(b.seats_qty || 0), 0);
      const capacity = Number(generalResource.capacity || 0);
      const remaining = Math.max(0, capacity - booked);
      return { remaining, capacity, booked };
    }

    async function privateIsBooked(roomCode, start, end){
      const room = resources.find(r => r.code === roomCode);
      if(!room) return true;

      const { data, error } = await sb
        .from("bookings")
        .select("id")
        .eq("resource_id", room.id)
        .eq("status", "paid")
        .lte("start_date", end)
        .gte("end_date", start)
        .limit(1);

      if(error) throw error;
      return (data || []).length > 0;
    }

    // ---------- Summary
    function syncSummaryFromGeneral(){
      const pkg = selectedPkg(genPackage);
      const start = genStart.value;
      const qty = Math.max(1, Number(genSeats.value || 1));

      summaryType.textContent = "General Space";
      summarySpace.textContent = `General (Seat Pool) √ó ${qty}`;
      if(pkg && start){
        const end = addDaysInclusive(start, pkg.duration_days);
        summaryDates.textContent = `${start} ‚Üí ${end}`;
        summaryPackage.textContent = pkg.name;
        summaryTotal.textContent = money(Number(pkg.price_ngn || 0) * qty);
      }else{
        summaryDates.textContent = start || "‚Äî";
        summaryPackage.textContent = pkg ? pkg.name : "‚Äî";
        summaryTotal.textContent = "‚Äî";
      }
    }

    function syncSummaryFromPrivate(){
      const pkg = selectedPkg(privPackage);
      const start = privDate.value;

      summaryType.textContent = "Private Space";
      summarySpace.textContent = privSelected ? `Room ${privSelected}` : "‚Äî";

      if(pkg && start){
        const end = addDaysInclusive(start, pkg.duration_days);
        summaryDates.textContent = `${start} ‚Üí ${end}`;
        summaryPackage.textContent = pkg.name;
        summaryTotal.textContent = money(Number(pkg.price_ngn || 0)); // private is qty 1
      }else{
        summaryDates.textContent = start || "‚Äî";
        summaryPackage.textContent = pkg ? pkg.name : "‚Äî";
        summaryTotal.textContent = "‚Äî";
      }
    }

    // ---------- Refresh (General)
    async function refreshGeneral(){
      syncSummaryFromGeneral();

      const start = genStart.value;
      const pkg = selectedPkg(genPackage);
      const qty = Math.max(1, Number(genSeats.value || 1));

      if(!start || !pkg){
        genAvailability.innerHTML = `<span class="badge warn">Select a date + package</span>`;
        genContinue.disabled = true;
        return;
      }

      const end = addDaysInclusive(start, pkg.duration_days);

      try{
        const { remaining, capacity } = await generalSeatsRemaining(start, end);

        if(qty <= remaining){
          genAvailability.innerHTML =
            `<span class="badge ok">Available</span>
             <span class="meta"> ${remaining} seats left (capacity ${capacity})</span>`;
          genContinue.disabled = false;
        }else{
          genAvailability.innerHTML =
            `<span class="badge no">Not enough seats</span>
             <span class="meta"> Only ${remaining} left for this range</span>`;
          genContinue.disabled = true;
        }
      }catch(e){
        console.error("General availability error:", e);
        genAvailability.innerHTML = `<span class="badge no">Unavailable</span>`;
        genContinue.disabled = true;
      }
    }

    // ---------- Refresh (Private)
    async function refreshPrivate(){
      syncSummaryFromPrivate();

      const start = privDate.value;
      const pkg = selectedPkg(privPackage);

      if(!start || !pkg){
        setChoiceEnabled(pickP01, false);
        setChoiceEnabled(pickP02, false);
        p01Badge.className = "badge warn"; p02Badge.className = "badge warn";
        p01Badge.textContent = "Select date"; p02Badge.textContent = "Select date";
        privSelected = null;
        privChosenEl.textContent = "‚Äî";
        privContinue.disabled = true;
        return;
      }

      const end = addDaysInclusive(start, pkg.duration_days);

      try{
        const p01Booked = await privateIsBooked("P01", start, end);
        const p02Booked = await privateIsBooked("P02", start, end);

        setChoiceEnabled(pickP01, !p01Booked);
        setChoiceEnabled(pickP02, !p02Booked);

        p01Badge.className = "badge " + (p01Booked ? "no" : "ok");
        p02Badge.className = "badge " + (p02Booked ? "no" : "ok");
        p01Badge.textContent = p01Booked ? "Booked" : "Available";
        p02Badge.textContent = p02Booked ? "Booked" : "Available";

        if(privSelected === "P01" && p01Booked) privSelected = null;
        if(privSelected === "P02" && p02Booked) privSelected = null;

        privChosenEl.textContent = privSelected ? privSelected : "‚Äî";
        privContinue.disabled = !(privSelected && start && pkg);
        syncSummaryFromPrivate();
      }catch(e){
        console.error("Private availability error:", e);
        p01Badge.className = "badge no"; p02Badge.className = "badge no";
        p01Badge.textContent = "Unavailable"; p02Badge.textContent = "Unavailable";
        setChoiceEnabled(pickP01, false);
        setChoiceEnabled(pickP02, false);
        privSelected = null;
        privChosenEl.textContent = "‚Äî";
        privContinue.disabled = true;
      }
    }

    function tryPick(roomCode){
      if(document.getElementById(roomCode === "P01" ? "pickP01" : "pickP02").getAttribute("aria-disabled") === "true"){
        return;
      }
      privSelected = roomCode;
      privChosenEl.textContent = roomCode;
      syncSummaryFromPrivate();
      privContinue.disabled = !(privDate.value && privPackage.value && privSelected);
    }

    pickP01.addEventListener("click", () => tryPick("P01"));
    pickP02.addEventListener("click", () => tryPick("P02"));
    pickP01.addEventListener("keydown", (e) => { if(e.key==="Enter") tryPick("P01"); });
    pickP02.addEventListener("keydown", (e) => { if(e.key==="Enter") tryPick("P02"); });

    // Create booking reference
    function makeBookingRef(){
      return "ZDH-" + (crypto.randomUUID ? crypto.randomUUID().slice(0,8) : String(Date.now()).slice(-8)).toUpperCase();
    }

    // Continue buttons (UPDATED: direct Paystack init + redirect)
    genContinue.addEventListener("click", async () => {
      const name = document.getElementById("fullName").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();

      if(!name || !email){ alert("Please enter your full name and email."); return; }

      const pkg = selectedPkg(genPackage);
      const start = genStart.value;
      const qty = Math.max(1, Number(genSeats.value || 1));
      const end = addDaysInclusive(start, pkg.duration_days);

      // re-check
      await refreshGeneral();
      if(genContinue.disabled) return;

      const booking_ref = makeBookingRef();
      const amount_ngn = Number(pkg.price_ngn || 0) * qty;

      const { error } = await sb.from("bookings").insert([{
        booking_ref,
        customer_name: name,
        customer_email: email,
        customer_phone: phone || null,
        resource_id: generalResource.id,
        package_id: pkg.id,
        start_date: start,
        end_date: end,
        seats_qty: qty,
        status: "pending",
        amount_ngn
      }]);

      if(error){
        console.error(error);
        alert("Booking failed. Check console.");
        return;
      }

      localStorage.setItem("zodHubPending", JSON.stringify({
        type: "general",
        booking_ref,
        startDate: start,
        endDate: end,
        seats: qty
      }));

     const res = await fetch(`${FUNCTIONS_BASE}/paystack-init`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
    "apikey": SUPABASE_ANON_KEY
  },
  body: JSON.stringify({
    booking_ref,
    callback_url: CALLBACK_URL
  })
});


      const json = await res.json();
      if (!res.ok) {
        alert(json.error || "Payment initialization failed");
        return;
      }

      // üî• GO STRAIGHT TO PAYSTACK
      window.location.href = json.authorization_url;
    });

    privContinue.addEventListener("click", async () => {
      const name = document.getElementById("privName").value.trim();
      const email = document.getElementById("privEmail").value.trim();

      if(!name || !email){ alert("Please enter your full name and email."); return; }
      if(!privSelected){ alert("Please choose P01 or P02."); return; }

      const pkg = selectedPkg(privPackage);
      const start = privDate.value;
      const end = addDaysInclusive(start, pkg.duration_days);

      // re-check
      await refreshPrivate();
      if(privContinue.disabled) return;

      const room = resources.find(r => r.code === privSelected);
      if(!room){ alert("Room resource missing in database."); return; }

      const booking_ref = makeBookingRef();
      const amount_ngn = Number(pkg.price_ngn || 0);

      const { error } = await sb.from("bookings").insert([{
        booking_ref,
        customer_name: name,
        customer_email: email,
        customer_phone: null,
        resource_id: room.id,
        package_id: pkg.id,
        start_date: start,
        end_date: end,
        seats_qty: 1,
        status: "pending",
        amount_ngn
      }]);

      if(error){
        console.error(error);
        alert("Booking failed. Check console.");
        return;
      }

      localStorage.setItem("zodHubPending", JSON.stringify({
        type: "private",
        booking_ref,
        room: privSelected,
        startDate: start,
        endDate: end
      }));

     const res = await fetch(`${FUNCTIONS_BASE}/paystack-init`, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
    "apikey": SUPABASE_ANON_KEY
  },
  body: JSON.stringify({
    booking_ref,
    callback_url: CALLBACK_URL
  })
});

      const json = await res.json();
      if (!res.ok) {
        alert(json.error || "Payment initialization failed");
        return;
      }

      // üî• GO STRAIGHT TO PAYSTACK
      window.location.href = json.authorization_url;
    });

    // Events
    genStart.addEventListener("change", refreshGeneral);
    genPackage.addEventListener("change", refreshGeneral);
    genSeats.addEventListener("input", refreshGeneral);

    privDate.addEventListener("change", async () => { privSelected = null; await refreshPrivate(); });
    privPackage.addEventListener("change", async () => { privSelected = null; await refreshPrivate(); });

    // Init
    (async function init(){
      // prevent past bookings
      const t = todayISO();
      genStart.min = t;
      privDate.min = t;

      genStart.value = t;
      privDate.value = t;

      try{
        try {
        await loadPackagesAndResources();
      } catch (err) {
        console.error("Failed to load packages/resources:", err);
        const msg = (err && err.message) ? err.message : String(err);
        // Show a visible banner so this is not silent in production
        const banner = document.createElement("div");
        banner.style.cssText = "margin:12px 0;padding:12px 14px;border-radius:12px;background:#fff3f3;border:1px solid #f3c3c3;color:#7f1d1d;font-weight:600;";
        banner.textContent = "Could not load packages. Please try again or contact support. (" + msg + ")";
        // Insert banner above the form
        const host = document.querySelector(".card .cardBody") || document.querySelector(".card") || document.body;
        host.prepend(banner);
        // Disable selects so users don‚Äôt proceed with broken data
        genPackage.innerHTML = '<option value="">No packages available</option>';
        privPackage.innerHTML = '<option value="">No packages available</option>';
        genPackage.disabled = true;
        privPackage.disabled = true;
        payBtn.disabled = true;
      }
      }catch(e){
        console.error(e);
        genAvailability.innerHTML = `<span class="badge no">Unavailable</span> <span class="meta"> Booking service error.</span>`;
        genContinue.disabled = true;
        p01Badge.className = "badge no"; p01Badge.textContent = "Unavailable";
        p02Badge.className = "badge no"; p02Badge.textContent = "Unavailable";
        privContinue.disabled = true;
        return;
      }

      syncSummaryFromGeneral();
      await refreshGeneral();
      await refreshPrivate();
    })();
  </script>
</body>
</html>
