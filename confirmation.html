<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking Confirmed — ZöD Hub</title>
  <style>
    :root{
      --bg:#fbfbf8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;
      --accent:#0b3b89;
      --radius:18px;
      --shadow:0 10px 28px rgba(2,6,23,.08);
      --shadow2:0 6px 16px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}

    .nav{
      position:sticky; top:0; z-index:10;
      background:rgba(251,251,248,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .container{max-width:1100px; margin:0 auto; padding:18px}
    .nav-inner{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .mark{width:34px; height:34px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#0ea5e9); box-shadow:var(--shadow2)}
    .nav-links{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .nav-links a{padding:10px 10px; border-radius:12px; color:var(--muted); font-weight:700}
    .nav-links a:hover{background:#fff; color:var(--text); box-shadow:var(--shadow2)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:14px;
      font-weight:900;
      border:1px solid transparent;
      cursor:pointer;
    }
    .btn-primary{background:var(--accent); color:#fff; box-shadow:var(--shadow2)}
    .btn-primary:hover{filter:brightness(.96)}
    .btn-outline{background:transparent; border-color:var(--line); color:var(--text)}
    .btn-outline:hover{background:#fff; box-shadow:var(--shadow2)}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .page-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin:10px 0 12px;
    }
    h1{margin:0; font-size:28px}
    .sub{color:var(--muted); font-size:13px}

    .layout{
      display:grid; grid-template-columns:1.1fr .9fr; gap:18px;
      align-items:start;
      margin-top:14px;
    }
    @media (max-width: 900px){ .layout{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      padding:16px;
    }
    .hr{height:1px; background:var(--line); margin:14px 0}
    .meta{color:var(--muted); font-size:13px}
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:900;
      border:1px solid var(--line);
      background:#fff;
    }
    .ok{border-color:#bbf7d0; background:#f0fdf4; color:#166534}
    .warn{border-color:#fde68a; background:#fffbeb; color:#92400e}

    .code-box{
      display:grid; gap:8px;
      border:1px dashed var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }
    .code{
      font-size:26px;
      font-weight:1000;
      letter-spacing:1px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
      color:var(--muted);
    }

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 700px){ .grid2{grid-template-columns:1fr} }

    .kv{
      display:flex; justify-content:space-between; gap:12px;
      padding:10px 0;
      border-bottom:1px solid var(--line);
      font-weight:900;
    }
    .kv span:first-child{color:var(--muted); font-weight:800}
    .kv:last-child{border-bottom:none}

    .qr{
      border:1px dashed var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      display:grid;
      gap:10px;
      place-items:center;
      min-height:220px;
    }
    canvas{max-width:100%}
    .sticky{position:sticky; top:88px}
    .note{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
      color:var(--muted);
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      display:none;
      box-shadow:var(--shadow);
      z-index:20;
    }
    @media print{
      .nav, .page-head .btn-outline, .actions, .toast{display:none !important}
      body{background:#fff}
      .card{box-shadow:none}
      .sticky{position:static}
    }
  
/* ===== NAVBAR: consistent CTA (BOOK NOW) ===== */
/* Only non-button nav links get the hover tile */
.nav-links a:not(.btn):hover{
  background:#fff;
  color:var(--text);
  box-shadow:var(--shadow2);
  opacity:1;
}
/* BOOK NOW stays blue + white always */
.nav-links a.btn.btn-primary,
.nav-links a.btn.btn-primary:visited{
  background: var(--accent);
  color:#fff;
  opacity:1;
  filter:none;
}
.nav-links a.btn.btn-primary:hover,
.nav-links a.btn.btn-primary:focus{
  background: var(--accent);
  color:#fff;
  opacity:1;
  filter:none;
  box-shadow: var(--shadow2);
}

</style>
</head>

<body>
  <!-- NAV -->
  <div class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html"><span class="mark"></span><span>ZöD Hub</span></a>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="faq.html">FAQs</a>
        <a href="location.html#contact">Contact</a>
        <a class="btn btn-primary" href="booking.html">BOOK NOW</a>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- HEADER -->
    <div class="page-head">
      <div>
        <h1>✅ Booking Confirmed</h1>
        <div class="sub" id="subline">Your booking details are ready. Present your code at the front desk.</div>
      </div>
      <button class="btn btn-outline" onclick="window.print()">Print / Save</button>
    </div>

    <section class="layout">
      <!-- LEFT: MAIN CONFIRMATION -->
      <div class="card">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">
          <div>
            <span class="badge ok">Payment successful</span>
            <span class="badge warn" id="validityBadge" style="margin-left:8px">Valid for your booking date</span>
          </div>
          <div class="pill" id="createdAtPill">Created: —</div>
        </div>

        <div class="hr"></div>

        <!-- Booking Code -->
        <div class="code-box">
          <b style="font-size:13px">Booking Code</b>
          <div class="code">
            <span id="bookingCode">—</span>
            <button class="btn btn-outline" id="copyBtn" type="button">Copy</button>
          </div>
          <div class="meta">Show this code (or QR) at the front desk to check in.</div>
        </div>

        <div class="hr"></div>

        <!-- QR -->
        <div class="qr">
          <b style="font-size:13px; justify-self:start">QR Code</b>
          <canvas id="qrCanvas" width="180" height="180"></canvas>
          <div class="meta" style="text-align:center">
            Staff can scan this QR to verify your booking instantly.
          </div>
        </div>

        <div class="hr"></div>

        <!-- Instructions -->
        <div class="note">
          <b style="font-size:13px">Arrival instructions</b><br />
          <span class="meta">
            Please arrive on your booking date and present your booking code (or QR) at the front desk.
            Your code is unique and should not be shared.
          </span>
        </div>

        <div class="hr"></div>

        <!-- Actions -->
        <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap">
          <a class="btn btn-primary" href="booking.html">Book another space</a>
          <button class="btn btn-outline" id="emailBtn" type="button">Email me this confirmation (demo)</button>
          <button class="btn btn-outline" id="clearBtn" type="button">Clear saved confirmation</button>
        </div>
      </div>

      <!-- RIGHT: DETAILS -->
      <aside class="card sticky">
        <b style="font-size:13px">Booking details</b>
        <div class="hr"></div>

        <div class="kv"><span>Name</span><span id="dName">—</span></div>
        <div class="kv"><span>Email</span><span id="dEmail">—</span></div>
        <div class="kv"><span>Type</span><span id="dType">—</span></div>
        <div class="kv"><span>Space</span><span id="dSpace">—</span></div>
        <div class="kv"><span>Package</span><span id="dPackage">—</span></div>
        <div class="kv"><span>Total</span><span id="dTotal">—</span></div>
        <div class="kv"><span>Date(s)</span><span id="dDates">—</span></div>
        <div class="kv"><span>Status</span><span><span class="badge ok">Confirmed</span></span></div>

        <div class="hr"></div>

        <div class="note">
          <b style="font-size:13px">Need help?</b><br />
          <span class="meta">If you have questions about your booking, contact ZöD Hub support.</span>
        </div>
      </aside>
    </section>
  </main>

  <div class="toast" id="toast">Copied</div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script>
    // ============================
    // PRODUCTION CONFIRMATION LOGIC
    // - Never creates bookings in the browser
    // - Only:
    //   (a) verify payment via Edge Function
    //   (b) load booking details by booking_code (RPC)
    // ============================

    const SUPABASE_URL = "https://eaunslmvqezqlukmuutf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhdW5zbG12cWV6cWx1a211dXRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NTA2NDcsImV4cCI6MjA4MjMyNjY0N30.JMlH4-tfDuhx8DwmJSSbHbbV5tGIkKYlIlYwxO0UND8";
    const hasSupabaseKeys = SUPABASE_URL.startsWith("http") && SUPABASE_ANON_KEY.length > 20;

    const sb = (hasSupabaseKeys && window.supabase)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const VERIFY_FN_URL = `${SUPABASE_URL}/functions/v1/verify-paystack`;

    // Query params
    const qs = new URLSearchParams(location.search);
    const codeParam = qs.get("code");
    const refParam = qs.get("reference") || qs.get("ref");

    // Helpers
    const el = (id) => document.getElementById(id);
    const toast = el("toast");

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 1500);
    }

    function safeText(v){ return (v === undefined || v === null || v === "") ? "—" : String(v); }

    const moneyNGN = (n) =>
      new Intl.NumberFormat("en-NG", { style: "currency", currency: "NGN" })
        .format(Number(n || 0));

    function setLoadingState(message){
      el("subline").textContent = message || "Loading confirmation…";
      el("bookingCode").textContent = "—";
      el("createdAtPill").textContent = "Created: —";
      el("copyBtn").disabled = true;

      el("dName").textContent = "—";
      el("dEmail").textContent = "—";
      el("dType").textContent = "—";
      el("dSpace").textContent = "—";
      el("dPackage").textContent = "—";
      el("dTotal").textContent = "—";
      el("dDates").textContent = "—";

      // Clear QR
      const canvas = el("qrCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function setEmptyState(message){
      setLoadingState(message || "No confirmation found. Please make a booking first.");
      el("subline").textContent = message || "No confirmation found. Please make a booking first.";
      el("emailBtn").disabled = true;
      el("emailBtn").textContent = "Email me this confirmation";
    }

    async function verifyPaystack(reference){
      const res = await fetch(VERIFY_FN_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + SUPABASE_ANON_KEY,
          "apikey": SUPABASE_ANON_KEY
        },
        body: JSON.stringify({ reference })
      });
      return await res.json();
    }

    // RPC: get_booking_by_code(p_code text)
    async function loadFromSupabaseByCode(code){
      if(!sb) return null;

      const { data: rows, error } = await sb.rpc("get_booking_by_code", { p_code: code });
      if(error || !rows) return null;

      const booking = Array.isArray(rows) ? rows[0] : rows;
      if(!booking) return null;

      const spaceCode = booking.space_code || booking.spaceCode || null;
      const spaceTypeRaw = booking.space_type || booking.spaceType || null;
      const spaceName = booking.space_name || booking.spaceName || null;

      const inferredType =
        spaceTypeRaw ? String(spaceTypeRaw).toLowerCase()
        : (spaceCode && String(spaceCode).toUpperCase().startsWith("G") ? "general" : "private");

      const start = booking.start_date || booking.startDate || booking.booking_date || booking.bookingDate || null;
      const end = booking.end_date || booking.endDate || booking.booking_date || booking.bookingDate || null;

      // If your RPC returns total/amount, use it; otherwise keep —
      const total = booking.total_amount || booking.amount || booking.total || null;

      return {
        bookingCode: booking.booking_code || booking.bookingCode || null,
        createdAt: booking.created_at || booking.createdAt || null,
        type: inferredType,
        spaceCode: spaceCode,
        spaceName: spaceName,
        package: booking.package || null,
        startDate: start,
        endDate: end,
        total: total,
        customer: {
          name: booking.customer_name || booking.customerName || null,
          email: booking.customer_email || booking.customerEmail || null,
          phone: booking.customer_phone || booking.customerPhone || null
        }
      };
    }

    async function drawRealQR(text){
      const canvas = el("qrCanvas");
      if(!canvas) return;

      // If the QR library is still loading, retry a few times (prevents blank QR)
      if (typeof window.QRCode === "undefined" || typeof window.QRCode.toCanvas !== "function") {
        window.__qrRetry = (window.__qrRetry || 0) + 1;
        if (window.__qrRetry <= 15) {
          setTimeout(() => drawRealQR(text), 200);
          return;
        }
        console.warn("QRCode library not loaded");
        return;
      }

      window.__qrRetry = 0;

      try{
        await window.QRCode.toCanvas(canvas, text || "ZODHUB", { margin: 1, width: 180 });
      }catch(e){
        console.warn("QR render failed:", e);
      }
    }catch(e){
        console.warn("QR render failed:", e);
      }
    }

    function renderUI(data){
      if(!data){
        setEmptyState("No confirmation found. Please make a booking first.");
        return;
      }

      // code
      el("bookingCode").textContent = safeText(data.bookingCode);
      el("copyBtn").disabled = !data.bookingCode;

      // created at
      const created = data.createdAt ? new Date(data.createdAt) : null;
      el("createdAtPill").textContent = "Created: " + (created ? created.toLocaleString() : "—");

      // real QR
      drawRealQR(data.bookingCode || "ZODHUB");

      // details
      el("dName").textContent = safeText(data.customer?.name);
      el("dEmail").textContent = safeText(data.customer?.email);

      const pkgText = data.package ? String(data.package).replace(/^GEN_/i,"").replace(/^PRIV_/i,"") : null;

      if(String(data.type).toLowerCase() === "general"){
        el("dType").textContent = "General Space";
        el("dSpace").textContent = data.spaceCode
          ? `General Pod ${data.spaceCode}`
          : (data.spaceName || "General Workstation");
        el("dPackage").textContent = safeText(pkgText ? pkgText.toLowerCase() : null);
      } else {
        el("dType").textContent = "Private Space";
        el("dSpace").textContent = data.spaceCode
          ? `Private Space ${data.spaceCode}`
          : (data.spaceName || "—");
        el("dPackage").textContent = safeText(pkgText ? pkgText.toLowerCase() : "daily");
      }

      el("dTotal").textContent = (data.total != null) ? moneyNGN(data.total) : "—";

      el("dDates").textContent =
        (data.endDate && data.endDate !== data.startDate)
          ? `${safeText(data.startDate)} → ${safeText(data.endDate)}`
          : safeText(data.startDate);

      // copy button
      el("copyBtn").onclick = async () => {
        try{
          await navigator.clipboard.writeText(data.bookingCode || "");
          showToast("Booking code copied");
        }catch{
          showToast("Copy not supported");
        }
      };

      // email button (kept as mailto helper; real email should be server-side)
      el("emailBtn").textContent = "Email me this confirmation";
      el("emailBtn").disabled = !data.customer?.email;

      el("emailBtn").onclick = () => {
        const subject = encodeURIComponent("ZöD Hub Booking Confirmation");
        const body = encodeURIComponent(
`Hello ${data.customer?.name || ""},

Your ZöD Hub booking is confirmed.

Booking Code: ${data.bookingCode}
Type: ${String(data.type).toLowerCase() === "general" ? "General Space" : "Private Space"}
Space: ${String(data.type).toLowerCase() === "general"
  ? (data.spaceCode ? ("General Pod " + data.spaceCode) : (data.spaceName || "General Workstation"))
  : (data.spaceCode ? ("Private Space " + data.spaceCode) : (data.spaceName || "Private Space"))}
Date: ${data.startDate || ""}

Please present your code at the front desk.

Thank you,
ZöD Hub`
        );
        const to = data.customer?.email || "";
        window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
      };

      // clear local helpers
      el("clearBtn").onclick = () => {
        localStorage.removeItem("zodHubLast");
        localStorage.removeItem("zodHubPending");
        showToast("Cleared");
        setTimeout(() => location.href = "booking.html", 350);
      };
    }

    (async () => {
      if(!sb){
        setEmptyState("Booking service is not configured. Please contact support.");
        return;
      }

      // 1) If already have code, load it
      if(codeParam){
        setLoadingState("Loading your booking details…");
        const data = await loadFromSupabaseByCode(codeParam);
        renderUI(data);
        return;
      }

      // 2) If returned from Paystack with reference, verify it (server finalizes booking)
      if(refParam){
        setLoadingState("Verifying payment…");

        try{
          const v = await verifyPaystack(refParam);

          if(!v.ok){
            setEmptyState("Payment verification failed. Please contact support with your reference: " + refParam);
            return;
          }

          // ✅ verify-paystack should return booking_code for BOTH general and private
          const bookingCode = v.booking_code;

          if(!bookingCode){
            setEmptyState("Payment verified, but booking code was not returned. Please contact support with your reference: " + refParam);
            return;
          }

          // Clean URL: redirect to ?code=... so refresh is safe
          location.replace(`confirmation.html?code=${encodeURIComponent(bookingCode)}`);
          return;

        }catch(e){
          console.error(e);
          setEmptyState("Unable to verify payment right now. Please contact support with your reference: " + refParam);
          return;
        }
      }

      // 3) Direct open without params
      setEmptyState("No confirmation found. Please make a booking first.");
    })();
  </script>
</body>
</html>