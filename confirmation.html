<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking Confirmed — ZöD Hub</title>
  <style>
    :root{
      --bg:#fbfbf8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;
      --accent:#0b3b89;
      --radius:18px;
      --shadow:0 10px 28px rgba(2,6,23,.08);
      --shadow2:0 6px 16px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}

    .nav{
      position:sticky; top:0; z-index:10;
      background:rgba(251,251,248,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .container{max-width:1100px; margin:0 auto; padding:18px}
    .nav-inner{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .mark{width:34px; height:34px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#0ea5e9); box-shadow:var(--shadow2)}
    .nav-links{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .nav-links a{padding:10px 10px; border-radius:12px; color:var(--muted); font-weight:700}
    .nav-links a:hover{background:#fff; color:var(--text); box-shadow:var(--shadow2)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:14px;
      font-weight:900;
      border:1px solid transparent;
      cursor:pointer;
    }
    .btn-primary{background:var(--accent); color:#fff; box-shadow:var(--shadow2)}
    .btn-primary:hover{filter:brightness(.96)}
    .btn-outline{background:transparent; border-color:var(--line); color:var(--text)}
    .btn-outline:hover{background:#fff; box-shadow:var(--shadow2)}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .page-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin:10px 0 12px;
    }
    h1{margin:0; font-size:28px}
    .sub{color:var(--muted); font-size:13px}

    .layout{
      display:grid; grid-template-columns:1.1fr .9fr; gap:18px;
      align-items:start;
      margin-top:14px;
    }
    @media (max-width: 900px){ .layout{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      padding:16px;
    }
    .hr{height:1px; background:var(--line); margin:14px 0}
    .meta{color:var(--muted); font-size:13px}
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:900;
      border:1px solid var(--line);
      background:#fff;
    }
    .ok{border-color:#bbf7d0; background:#f0fdf4; color:#166534}
    .warn{border-color:#fde68a; background:#fffbeb; color:#92400e}

    .code-box{
      display:grid; gap:8px;
      border:1px dashed var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }
    .code{
      font-size:26px;
      font-weight:1000;
      letter-spacing:1px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
      color:var(--muted);
    }

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 700px){ .grid2{grid-template-columns:1fr} }

    .kv{
      display:flex; justify-content:space-between; gap:12px;
      padding:10px 0;
      border-bottom:1px solid var(--line);
      font-weight:900;
    }
    .kv span:first-child{color:var(--muted); font-weight:800}
    .kv:last-child{border-bottom:none}

    .qr{
      border:1px dashed var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      display:grid;
      gap:10px;
      place-items:center;
      min-height:220px;
    }
    canvas{max-width:100%}
    .sticky{position:sticky; top:88px}
    .note{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
      color:var(--muted);
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      display:none;
      box-shadow:var(--shadow);
      z-index:20;
    }
    @media print{
      .nav, .page-head .btn-outline, .actions, .toast{display:none !important}
      body{background:#fff}
      .card{box-shadow:none}
      .sticky{position:static}
    }
  
/* ===== NAVBAR: consistent CTA (BOOK NOW) ===== */
/* Only non-button nav links get the hover tile */
.nav-links a:not(.btn):hover{
  background:#fff;
  color:var(--text);
  box-shadow:var(--shadow2);
  opacity:1;
}
/* BOOK NOW stays blue + white always */
.nav-links a.btn.btn-primary,
.nav-links a.btn.btn-primary:visited{
  background: var(--accent);
  color:#fff;
  opacity:1;
  filter:none;
}
.nav-links a.btn.btn-primary:hover,
.nav-links a.btn.btn-primary:focus{
  background: var(--accent);
  color:#fff;
  opacity:1;
  filter:none;
  box-shadow: var(--shadow2);
}

</style>
</head>

<body>
  <!-- NAV -->
  <div class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html"><span class="mark"></span><span>ZöD Hub</span></a>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="faq.html">FAQs</a>
        <a href="location.html#contact">Contact</a>
        <a class="btn btn-primary" href="booking.html">BOOK NOW</a>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- HEADER -->
    <div class="page-head">
      <div>
        <h1 id="headline">✅ Booking Confirmed</h1>
        <div class="sub" id="subline">Your booking details are ready. Present your code at the front desk.</div>
      </div>
      <button class="btn btn-outline" onclick="window.print()">Print / Save</button>
    </div>

    <section class="layout">
      <!-- LEFT: MAIN CONFIRMATION -->
      <div class="card">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">
          <div>
            <span class="badge ok" id="payBadge">Payment successful</span>
            <span class="badge warn" id="validityBadge" style="margin-left:8px">Valid for your booking date</span>
          </div>
          <div class="pill" id="createdAtPill">Created: —</div>
        </div>

        <div class="hr"></div>

        <!-- Booking Code -->
        <div class="code-box">
          <b style="font-size:13px">Booking Code</b>
          <div class="code">
            <span id="bookingCode">—</span>
            <button class="btn btn-outline" id="copyBtn" type="button">Copy</button>
          </div>
          <div class="meta">Show this code  at the front desk to check in.</div>
        </div>

        <div class="hr"></div>
<!-- Instructions -->
        <div class="note">
          <b style="font-size:13px">Arrival instructions</b><br />
          <span class="meta">
            Please arrive on your booking date and present your booking code  at the front desk.
            Your code is unique and should not be shared.
          </span>
        </div>

        <div class="hr"></div>

        <!-- Actions -->
        <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap">
          <a class="btn btn-primary" href="booking.html">Book another space</a>
          <button class="btn btn-outline" id="emailBtn" type="button">Email me this confirmation (demo)</button>
          <button class="btn btn-outline" id="clearBtn" type="button">Clear saved confirmation</button>
        </div>
      </div>

      <!-- RIGHT: DETAILS -->
      <aside class="card sticky">
        <b style="font-size:13px">Booking details</b>
        <div class="hr"></div>

        <div class="kv"><span>Name</span><span id="dName">—</span></div>
        <div class="kv"><span>Email</span><span id="dEmail">—</span></div>
        <div class="kv"><span>Type</span><span id="dType">—</span></div>
        <div class="kv"><span>Space</span><span id="dSpace">—</span></div>
        <div class="kv"><span>Package</span><span id="dPackage">—</span></div>
        <div class="kv"><span>Total</span><span id="dTotal">—</span></div>
        <div class="kv"><span>Date(s)</span><span id="dDates">—</span></div>
        <div class="kv"><span>Status</span><span id="dStatus"><span class="badge ok">Confirmed</span></span></div>

        <div class="hr"></div>

        <div class="note">
          <b style="font-size:13px">Need help?</b><br />
          <span class="meta">If you have questions about your booking, contact ZöD Hub support.</span>
        </div>
      </aside>
    </section>
  </main>

  <div class="toast" id="toast">Copied</div>

    
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
  // ====== Confirmation logic (NO QR) ======
  const SUPABASE_URL = "https://dzazdrpgedrrcnuzgjjc.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6YXpkcnBnZWRycmNudXpnampjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjUxOTQsImV4cCI6MjA4MjcwMTE5NH0.8ZRnOiGtyfi5ibmTbKLROnQ4PqBIDvDfeH-mWGUQy_M";
  const FUNCTIONS_BASE = "https://dzazdrpgedrrcnuzgjjc.functions.supabase.co";
  const VERIFY_FN_URL = `${FUNCTIONS_BASE}/paystack-verify`;

  const sb = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);

  const qs = new URLSearchParams(location.search);
  const reference = qs.get("reference");
  const codeParam = qs.get("code");

  const el = (id) => document.getElementById(id);
  const toast = el("toast");

  function showToast(msg){
    if(!toast) return;
    toast.textContent = msg;
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 1500);
  }

  function safeText(v){ return (v === undefined || v === null || v === "") ? "—" : String(v); }
  const moneyNGN = (n) => new Intl.NumberFormat("en-NG",{style:"currency",currency:"NGN"}).format(Number(n||0));

  function setBadState(title, message){
    el("headline").textContent = title || "Error loading confirmation";
    el("subline").textContent = message || "Please contact support.";
    el("payBadge").className = "badge no";
    el("payBadge").textContent = "Not confirmed";
    el("bookingCode").textContent = "—";
    el("createdAtPill").textContent = "Created: —";
    el("copyBtn").disabled = true;

    el("dName").textContent = "—";
    el("dEmail").textContent = "—";
    el("dType").textContent = "—";
    el("dSpace").textContent = "—";
    el("dPackage").textContent = "—";
    el("dTotal").textContent = "—";
    el("dDates").textContent = "—";
    el("dStatus").innerHTML = '<span class="badge no">Failed</span>';
  }

  async function verifyPayment(reference){
    const res = await fetch(VERIFY_FN_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      },
      body: JSON.stringify({ reference }),
    });
    const json = await res.json();
    if(!res.ok) throw new Error(json.error || "Payment verification failed");
    if(!json.ok) throw new Error("Payment not successful");
    return json.booking_ref; // from Paystack metadata
  }

  async function loadBooking(booking_ref){
    const { data, error } = await sb
      .from("bookings")
      .select(`
        booking_ref,
        customer_name,
        customer_email,
        start_date,
        end_date,
        amount_ngn,
        status,
        created_at,
        resources:resource_id ( code, name, type ),
        packages:package_id ( name )
      `)
      .eq("booking_ref", booking_ref)
      .single();

    if(error) throw error;
    return data;
  }

  function render(booking){
    const status = String(booking.status || "").toLowerCase();
    const paid = status === "paid";

    el("payBadge").className = "badge " + (paid ? "ok" : "warn");
    el("payBadge").textContent = paid ? "Payment successful" : "Pending";

    el("headline").textContent = paid ? "✅ Booking Confirmed" : "⏳ Booking Pending";
    el("subline").textContent = paid
      ? "Your booking details are ready. Present your code at the front desk."
      : "Your booking is created but not yet confirmed. If you paid, refresh this page.";

    el("bookingCode").textContent = safeText(booking.booking_ref);
    el("copyBtn").disabled = !booking.booking_ref;

    const created = booking.created_at ? new Date(booking.created_at) : null;
    el("createdAtPill").textContent = "Created: " + (created ? created.toLocaleString() : "—");

    el("dName").textContent = safeText(booking.customer_name);
    el("dEmail").textContent = safeText(booking.customer_email);

    const res = booking.resources || {};
    const pkg = booking.packages || {};

    const type = String(res.type || "").toLowerCase();
    el("dType").textContent = type === "general" ? "General Space" : (type === "private" ? "Private Space" : safeText(res.type));
    el("dSpace").textContent = res.name ? `${res.name} (${res.code || ""})` : safeText(res.code);

    el("dPackage").textContent = safeText(pkg.name);
    el("dTotal").textContent = moneyNGN(booking.amount_ngn);

    const start = booking.start_date;
    const end = booking.end_date;
    el("dDates").textContent = (end && end !== start) ? `${start} → ${end}` : safeText(start);

    el("dStatus").innerHTML = paid ? '<span class="badge ok">Confirmed</span>' : '<span class="badge warn">Pending</span>';

    // copy
    el("copyBtn").onclick = async () => {
      try{
        await navigator.clipboard.writeText(booking.booking_ref || "");
        showToast("Booking code copied");
      }catch(e){
        showToast("Copy not supported");
      }
    };
  }

  (async function init(){
    try{
      if(!sb) throw new Error("Supabase client not loaded");
      let booking_ref = null;

      if(reference){
        booking_ref = await verifyPayment(reference);
      }else if(codeParam){
        booking_ref = codeParam;
      }else{
        throw new Error("Missing reference or code in the URL");
      }

      const booking = await loadBooking(booking_ref);
      render(booking);
    }catch(e){
      console.error(e);
      setBadState("Error loading confirmation", String(e?.message || e));
    }
  })();
</script>
</body>
</html>
