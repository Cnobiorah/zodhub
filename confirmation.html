<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Booking Confirmed — ZöD Hub</title>
  <!-- ✅ KEEPING YOUR OLD STYLE EXACTLY -->
  <style>
    :root{
      --bg:#fbfbf8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;
      --accent:#0b3b89;
      --radius:18px;
      --shadow:0 10px 28px rgba(2,6,23,.08);
      --shadow2:0 6px 16px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}

    .nav{
      position:sticky; top:0; z-index:10;
      background:rgba(251,251,248,.85);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .container{max-width:1100px; margin:0 auto; padding:18px}
    .nav-inner{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .mark{width:34px; height:34px; border-radius:12px; background:linear-gradient(135deg,var(--accent),#0ea5e9); box-shadow:var(--shadow2)}
    .nav-links{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .nav-links a{padding:10px 10px; border-radius:12px; color:var(--muted); font-weight:700}
    .nav-links a:hover{background:#fff; color:var(--text); box-shadow:var(--shadow2)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:14px;
      font-weight:900;
      border:1px solid transparent;
      cursor:pointer;
    }
    .btn-primary{background:var(--accent); color:#fff; box-shadow:var(--shadow2)}
    .btn-primary:hover{filter:brightness(.96)}
    .btn-outline{background:transparent; border-color:var(--line); color:var(--text)}
    .btn-outline:hover{background:#fff; box-shadow:var(--shadow2)}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .page-head{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin:10px 0 12px;
    }
    h1{margin:0; font-size:28px}
    .sub{color:var(--muted); font-size:13px}

    .layout{
      display:grid; grid-template-columns:1.1fr .9fr; gap:18px;
      align-items:start;
      margin-top:14px;
    }
    @media (max-width: 900px){ .layout{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      padding:16px;
    }
    .hr{height:1px; background:var(--line); margin:14px 0}
    .meta{color:var(--muted); font-size:13px}
    .badge{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:900;
      border:1px solid var(--line);
      background:#fff;
    }
    .ok{border-color:#bbf7d0; background:#f0fdf4; color:#166534}
    .warn{border-color:#fde68a; background:#fffbeb; color:#92400e}
    .no{border-color:#fecaca; background:#fef2f2; color:#991b1b}

    .code-box{
      display:grid; gap:8px;
      border:1px dashed var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
    }
    .code{
      font-size:26px;
      font-weight:1000;
      letter-spacing:1px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      font-size:12px;
      color:var(--muted);
    }

    .kv{
      display:flex; justify-content:space-between; gap:12px;
      padding:10px 0;
      border-bottom:1px solid var(--line);
      font-weight:900;
    }
    .kv span:first-child{color:var(--muted); font-weight:800}
    .kv:last-child{border-bottom:none}

    .qr{
      border:1px dashed var(--line);
      border-radius:16px;
      padding:14px;
      background:#fff;
      display:grid;
      gap:10px;
      place-items:center;
      min-height:220px;
    }
    canvas{max-width:100%}
    .sticky{position:sticky; top:88px}
    .note{
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
      color:var(--muted);
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      display:none;
      box-shadow:var(--shadow);
      z-index:20;
    }
    @media print{
      .nav, .page-head .btn-outline, .actions, .toast{display:none !important}
      body{background:#fff}
      .card{box-shadow:none}
      .sticky{position:static}
    }

    /* ===== NAVBAR: consistent CTA (BOOK NOW) ===== */
    .nav-links a:not(.btn):hover{
      background:#fff;
      color:var(--text);
      box-shadow:var(--shadow2);
      opacity:1;
    }
    .nav-links a.btn.btn-primary,
    .nav-links a.btn.btn-primary:visited{
      background: var(--accent);
      color:#fff;
      opacity:1;
      filter:none;
    }
    .nav-links a.btn.btn-primary:hover,
    .nav-links a.btn.btn-primary:focus{
      background: var(--accent);
      color:#fff;
      opacity:1;
      filter:none;
      box-shadow: var(--shadow2);
    }
  </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html"><span class="mark"></span><span>ZöD Hub</span></a>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="faq.html">FAQs</a>
        <a href="location.html#contact">Contact</a>
        <a class="btn btn-primary" href="booking.html">BOOK NOW</a>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- HEADER -->
    <div class="page-head">
      <div>
        <h1 id="headline">✅ Booking Confirmed</h1>
        <div class="sub" id="subline">Your booking details are ready. Present your code at the front desk.</div>
      </div>
      <button class="btn btn-outline" onclick="window.print()">Print / Save</button>
    </div>

    <section class="layout">
      <!-- LEFT -->
      <div class="card">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">
          <div>
            <span class="badge ok" id="payBadge">Payment successful</span>
            <span class="badge warn" id="validityBadge" style="margin-left:8px">Valid for your booking date</span>
          </div>
          <div class="pill" id="createdAtPill">Created: —</div>
        </div>

        <div class="hr"></div>

        <!-- Booking Code -->
        <div class="code-box">
          <b style="font-size:13px">Booking Code</b>
          <div class="code">
            <span id="bookingCode">—</span>
            <button class="btn btn-outline" id="copyBtn" type="button">Copy</button>
          </div>
          <div class="meta">Show this code (or QR) at the front desk to check in.</div>
        </div>

        <div class="hr"></div>

        <!-- QR -->
        <div class="qr">
          <b style="font-size:13px; justify-self:start">QR Code</b>
          <canvas id="qrCanvas" width="180" height="180"></canvas>
          <div class="meta" style="text-align:center">
            Staff can scan this QR to verify your booking instantly.
          </div>
        </div>

        <div class="hr"></div>

        <!-- Instructions -->
        <div class="note">
          <b style="font-size:13px">Arrival instructions</b><br />
          <span class="meta">
            Please arrive on your booking date and present your booking code (or QR) at the front desk.
            Your code is unique and should not be shared.
          </span>
        </div>

        <div class="hr"></div>

        <!-- Actions -->
        <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap">
          <a class="btn btn-primary" href="booking.html">Book another space</a>
          <button class="btn btn-outline" id="emailBtn" type="button">Email me this confirmation</button>
          <button class="btn btn-outline" id="clearBtn" type="button">Clear saved confirmation</button>
        </div>
      </div>

      <!-- RIGHT -->
      <aside class="card sticky">
        <b style="font-size:13px">Booking details</b>
        <div class="hr"></div>

        <div class="kv"><span>Name</span><span id="dName">—</span></div>
        <div class="kv"><span>Email</span><span id="dEmail">—</span></div>
        <div class="kv"><span>Type</span><span id="dType">—</span></div>
        <div class="kv"><span>Space</span><span id="dSpace">—</span></div>
        <div class="kv"><span>Package</span><span id="dPackage">—</span></div>
        <div class="kv"><span>Total</span><span id="dTotal">—</span></div>
        <div class="kv"><span>Date(s)</span><span id="dDates">—</span></div>
        <div class="kv"><span>Status</span><span id="dStatus">—</span></div>

        <div class="hr"></div>

        <div class="note">
          <b style="font-size:13px">Need help?</b><br />
          <span class="meta">If you have questions about your booking, contact ZöD Hub support.</span>
        </div>
      </aside>
    </section>
  </main>

  <div class="toast" id="toast">Copied</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script>
    // ============================
    // OPTION B (NEW DB) CONFIRMATION LOGIC
    // - UI stays identical to your old page
    // - Works with tables: bookings, resources, packages
    // - Paystack redirects here with ?reference=xxxx
    // - We call Edge Function paystack-verify to mark booking paid
    // - Then load booking details by booking_ref
    // ============================

    // ✅ Put your real values (anon key is safe in browser)
    const SUPABASE_URL = "https://dzazdrpgedrrcnuzgjjc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6YXpkcnBnZWRycmNudXpnampjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjUxOTQsImV4cCI6MjA4MjcwMTE5NH0.8ZRnOiGtyfi5ibmTbKLROnQ4PqBIDvDfeH-mWGUQy_M";

    // ✅ Your Edge Function endpoint (change name if your function is different)
    const FUNCTIONS_BASE = "https://dzazdrpgedrrcnuzgjjc.functions.supabase.co";
    const VERIFY_FN = "paystack-verify";

    const hasSupabaseKeys = SUPABASE_URL.startsWith("http") && SUPABASE_ANON_KEY.length > 20;
    const sb = (hasSupabaseKeys && window.supabase)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const qs = new URLSearchParams(location.search);
    const reference = qs.get("reference") || qs.get("ref"); // Paystack uses ?reference=
    const bookingRefDirect = qs.get("code"); // we also support confirmation.html?code=ZOD-...

    const el = (id) => document.getElementById(id);
    const toast = el("toast");

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 1500);
    }
    function safeText(v){ return (v === undefined || v === null || v === "") ? "—" : String(v); }
    const moneyNGN = (n) =>
      new Intl.NumberFormat("en-NG", { style: "currency", currency: "NGN" })
        .format(Number(n || 0));
		
		// QR: draw into <canvas id="qrCanvas">
function renderQRToCanvas(text){
  const canvas = document.getElementById("qrCanvas");
  if (!canvas || !text) return;

  QRCode.toCanvas(
    canvas,
    text,
    { width: 180, margin: 1 },
    (error) => { if (error) console.error("QR error:", error); }
  );
}


    function setBadState(title, message){
      el("headline").textContent = title || "Verification error";
      el("subline").textContent = message || "Please contact support.";

      el("payBadge").className = "badge no";
      el("payBadge").textContent = "Not confirmed";

      el("bookingCode").textContent = "—";
      el("createdAtPill").textContent = "Created: —";
      el("copyBtn").disabled = true;

      el("dName").textContent = "—";
      el("dEmail").textContent = "—";
      el("dType").textContent = "—";
      el("dSpace").textContent = "—";
      el("dPackage").textContent = "—";
      el("dTotal").textContent = "—";
      el("dDates").textContent = "—";
      el("dStatus").innerHTML = `<span class="badge no">Failed</span>`;

      // Clear QR
      const canvas = el("qrCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    async function drawQR(text){
      const canvas = el("qrCanvas");
      try{
        await QRCode.toCanvas(canvas, text || "ZODHUB", { margin: 1, width: 180 });
      }catch(e){
        console.warn("QR failed:", e);
      }
    }

    async function verifyPaystack(ref){
      const r = await fetch(`${FUNCTIONS_BASE}/${VERIFY_FN}`, {
        method: "POST",
        headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      "apikey": SUPABASE_ANON_KEY
    },
        body: JSON.stringify({ reference: ref })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j.error || "Verification failed");
      return j; // expected: { ok:true, booking_ref, reference, paidAmountNgn }
    }

    async function loadBookingByRef(booking_ref){
      // Requires a SELECT policy that allows reading bookings.
      // (You can later tighten this; for now it’s fine for launch.)
      const { data, error } = await sb
        .from("bookings")
        .select(`
          booking_ref,
          customer_name,
          customer_email,
          start_date,
          end_date,
          seats_qty,
          amount_ngn,
          status,
          created_at,
          paystack_reference,
          resources:resource_id ( code, name, type ),
          packages:package_id ( name, duration_days )
        `)
        .eq("booking_ref", booking_ref)
        .single();

      if(error) throw error;
      return data;
    }

    function render(booking){
      // badges / header
      const status = String(booking.status || "").toLowerCase();
      if(status === "paid"){
        el("payBadge").className = "badge ok";
        el("payBadge").textContent = "Payment successful";
        el("dStatus").innerHTML = `<span class="badge ok">Confirmed</span>`;
      }else{
        el("payBadge").className = "badge warn";
        el("payBadge").textContent = "Pending";
        el("dStatus").innerHTML = `<span class="badge warn">Pending</span>`;
      }

      el("headline").textContent = status === "paid" ? "✅ Booking Confirmed" : "⏳ Booking Pending";
      el("subline").textContent = status === "paid"
        ? "Your booking details are ready. Present your code at the front desk."
        : "Your booking is created but not yet confirmed. If you paid, refresh this page.";

      // booking code (use booking_ref as the code)
      el("bookingCode").textContent = safeText(booking.booking_ref);
      el("copyBtn").disabled = !booking.booking_ref;

      // created at pill
      const created = booking.created_at ? new Date(booking.created_at) : null;
      el("createdAtPill").textContent = "Created: " + (created ? created.toLocaleString() : "—");

      // details right
      el("dName").textContent = safeText(booking.customer_name);
      el("dEmail").textContent = safeText(booking.customer_email);

      const res = booking.resources || {};
      const pkg = booking.packages || {};

      const type = (res.type || "").toLowerCase();
      if(type === "general"){
        el("dType").textContent = "General Space";
        el("dSpace").textContent = res.name ? `${res.name} (${res.code})` : (res.code || "GENERAL");
      }else if(type === "private"){
        el("dType").textContent = "Private Space";
        el("dSpace").textContent = res.name ? `${res.name} (${res.code})` : (res.code || "P01/P02");
      }else{
        el("dType").textContent = safeText(res.type);
        el("dSpace").textContent = res.name || res.code || "—";
      }

      el("dPackage").textContent = safeText(pkg.name);
      el("dTotal").textContent = moneyNGN(booking.amount_ngn);

      const start = booking.start_date;
      const end = booking.end_date;
      el("dDates").textContent = (end && end !== start) ? `${start} → ${end}` : safeText(start);

      // QR
      drawQR(booking.booking_ref || "ZODHUB");

      // copy
      el("copyBtn").onclick = async () => {
        try{
          await navigator.clipboard.writeText(booking.booking_ref || "");
          showToast("Booking code copied");
        }catch{
          showToast("Copy not supported");
        }
      };

      // email (mailto)
      el("emailBtn").disabled = !booking.customer_email;
      el("emailBtn").onclick = () => {
        const subject = encodeURIComponent("ZöD Hub Booking Confirmation");
        const body = encodeURIComponent(
`Hello ${booking.customer_name || ""},

Your ZöD Hub booking is ${status === "paid" ? "CONFIRMED" : "PENDING"}.

Booking Code: ${booking.booking_ref}
Type: ${type === "general" ? "General Space" : (type === "private" ? "Private Space" : safeText(res.type))}
Space: ${res.name ? `${res.name} (${res.code})` : safeText(res.code)}
Package: ${pkg.name || ""}
Dates: ${(end && end !== start) ? `${start} → ${end}` : (start || "")}
Total: ${moneyNGN(booking.amount_ngn)}

Please present your booking code at the front desk.

Thank you,
ZöD Hub`
        );
        window.location.href = `mailto:${encodeURIComponent(booking.customer_email)}?subject=${subject}&body=${body}`;
      };

      // clear
      el("clearBtn").onclick = () => {
        localStorage.removeItem("zodHubLast");
        localStorage.removeItem("zodHubPending");
        showToast("Cleared");
        setTimeout(() => location.href = "booking.html", 350);
      };

      // cache last confirmation
      try { localStorage.setItem("zodHubLast", JSON.stringify({ booking_ref: booking.booking_ref })); } catch {}
    }

    (async () => {
      if(!sb){
        setBadState("Service not configured", "Supabase keys are missing. Please contact support.");
        return;
      }

      try{
        // A) Paystack redirect: verify by reference, then redirect to ?code=
        if(reference){
          el("subline").textContent = "Verifying payment…";
          const v = await verifyPaystack(reference);

          if(!v.ok || !v.booking_ref){
            setBadState("Payment verification failed", "Please contact support with your Paystack reference: " + reference);
            return;
          }

          // Clean URL for refresh safety
          location.replace(`confirmation.html?code=${encodeURIComponent(v.booking_ref)}`);
          return;
        }

        // B) Direct open by code
        const booking_ref =
          bookingRefDirect ||
          (() => {
            try {
              const last = JSON.parse(localStorage.getItem("zodHubLast") || "null");
              return last?.booking_ref || null;
            } catch { return null; }
          })();

        if(!booking_ref){
          setBadState("No confirmation found", "No booking code was provided. Please make a booking first.");
          return;
        }

        el("subline").textContent = "Loading your booking details…";
        const booking = await loadBookingByRef(booking_ref);
        render(booking);

      }catch(e){
        console.error(e);
        setBadState("Error loading confirmation", e?.message || String(e));
      }
    })();
  </script>
</body>
</html>
